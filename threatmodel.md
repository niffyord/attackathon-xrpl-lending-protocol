# XRPL Lending Protocol Threat Model

The analysis below consolidates the lending protocol logic, supporting vault primitives, and post-transaction invariants added to `rippled`. Each component summarizes who can mutate state, which subsystems it depends on, what invariants guard funds, the operating assumptions, and the main attack surfaces observed while reviewing the in-scope code and documentation.

| Component | Privileges | External Dependencies | Critical Invariants | Assumptions | Attack Surfaces |
| --- | --- | --- | --- | --- | --- |
| **Amendment & feature gating** | Validators must enable Single Asset Vault (SAV) plus subordinate amendments before any lending transaction passes feature checks; lending operations piggyback on the same prerequisite guard. 【F:src/xrpld/app/misc/detail/LendingHelpers.cpp†L26-L31】【F:src/xrpld/app/tx/detail/VaultCreate.cpp†L38-L55】 | Depends on amendment flags for SAV, MPTokensV1, and Permissioned Domains when DomainID is used; Vault creation reuses pseudo-account helpers and issuer lookups. 【F:src/xrpld/app/tx/detail/VaultCreate.cpp†L38-L139】 | Transactions abort when prerequisites are missing or required registry objects (permissioned domains, issuers) are absent, preventing partial activation. 【F:src/xrpld/app/tx/detail/VaultCreate.cpp†L114-L139】 | XRPL currently provides no smart-contract fallback, so native amendments must remain consistent across the validator UNL. 【F:ATTACKATHON.md†L28-L32】 | Future amendments or assets that bypass the existing guard list could activate lending logic without all mitigations; additional dependencies must be wired into the shared `checkLendingProtocolDependencies` path. 【F:src/xrpld/app/misc/detail/LendingHelpers.cpp†L26-L31】 |
| **Single Asset Vault subsystem** | Vault owners authorize creation, deposits, and withdrawals; destination accounts must pass authorization and freeze checks before assets or shares move. 【F:src/xrpld/app/tx/detail/VaultCreate.cpp†L114-L139】【F:src/xrpld/app/tx/detail/VaultWithdraw.cpp†L60-L134】 | Requires MPT share issuance, trust-line authorization, and recursive freeze/deep-freeze inspection; share ↔ asset conversions call into SAV math helpers. 【F:src/xrpld/app/tx/detail/VaultWithdraw.cpp†L90-L170】 | Vault totals cannot drop below available balances and unrealized losses are realized on default; post-transaction invariants snapshot vault asset/share state. 【F:src/xrpld/app/tx/detail/LoanManage.cpp†L166-L236】【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2538-L2555】 | Institutional collateral may sit with off-chain custodians, so ledger balances can diverge from real custody unless operators coordinate manually. 【F:ATTACKATHON.md†L28-L31】 | Share redemption and dust-handling rely on precise rounding; overflow or rounding drift in conversions could leak assets if guard rails fail. 【F:src/xrpld/app/tx/detail/VaultWithdraw.cpp†L90-L170】【F:src/xrpld/app/tx/detail/LoanManage.cpp†L170-L227】 |
| **Loan broker & cover management** | Broker owners create brokers, manage pseudo-accounts, and must maintain XRP reserve plus cover; issuers may claw cover subject to authorization. 【F:src/xrpld/app/tx/detail/LoanBrokerSet.cpp†L131-L181】【F:src/xrpld/app/tx/detail/LoanBrokerCoverDeposit.cpp†L53-L123】 | Interacts with SAV assets, Payment engine for third-party withdrawals, freeze/deep-freeze enforcement, and issuer clawback rules. 【F:src/xrpld/app/tx/detail/LoanBrokerCoverWithdraw.cpp†L100-L200】【F:include/xrpl/ledger/View.h†L221-L279】 | Minimum cover calculations gate withdrawals, and invariants forbid negative debt or cover after any transaction. 【F:src/xrpld/app/tx/detail/LoanBrokerCoverWithdraw.cpp†L118-L139】【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2440-L2458】 | Numeric rounding defaults to “nearest,” so precision guards must be used consistently when converting required cover into ledger quanta. 【F:src/libxrpl/basics/Number.cpp†L42-L55】【F:include/xrpl/protocol/STAmount.h†L739-L751】 | Any missed rounding guard or freeze check lets brokers leak first-loss capital (e.g., cover rounding down, deep-freeze vs. issuer-freeze mismatches) or route funds through the Payment engine in unexpected ways. 【F:src/xrpld/app/tx/detail/LoanBrokerCoverWithdraw.cpp†L121-L200】【F:src/xrpld/app/tx/detail/LoanBrokerCoverDeposit.cpp†L71-L90】 |
| **Loan lifecycle processing** | Brokers and borrowers submit LoanSet with optional counterparty signatures; LoanPay and LoanManage mutate balances while respecting reserves and impairment flags. 【F:src/xrpld/app/tx/detail/LoanSet.cpp†L80-L180】【F:src/xrpld/app/tx/detail/LoanPay.cpp†L240-L333】 | Relies on lending math helpers for periodic rates, rounding, and payment breakdowns, plus vault references for fee routing. 【F:src/xrpld/app/misc/LendingHelpers.h†L34-L109】【F:src/xrpld/app/misc/detail/LendingHelpers.cpp†L57-L68】 | Debt caps, minimum cover, borrower reserve increments, and default processing enforce lender protection; invariants reject negative or zero-valued loan fields. 【F:src/xrpld/app/tx/detail/LoanSet.cpp†L487-L508】【F:src/xrpld/app/tx/detail/LoanManage.cpp†L166-L236】【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2506-L2533】 | Payment schedules assume on-ledger enforcement with no programmable fallback, so manual coordination is needed if borrowers default while off-ledger collateral is involved. 【F:ATTACKATHON.md†L28-L31】 | Precision or freeze gaps let borrowers or brokers exploit rounding (e.g., minimum cover comparisons, fee diversion when only deep-freeze is checked) or misuse payment flags. 【F:src/libxrpl/basics/Number.cpp†L42-L55】【F:src/xrpld/app/tx/detail/LoanPay.cpp†L258-L290】 |
| **Ledger invariants & pseudo-account framework** | Only transaction code can create pseudo-accounts and link owner directories; post-apply invariant visitors inspect any modified broker, loan, or vault entry. 【F:include/xrpl/ledger/View.h†L640-L676】【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2380-L2535】 | Uses directory traversal, keylet lookups, and feature flags to ensure invariants run when lending amendments are live. 【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2380-L2440】【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2422-L2426】 | Enforces monotonic broker sequences, non-negative cover/debt, zero principal when payments are exhausted, and pseudo-account hygiene. 【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2440-L2535】 | Assumes invariant enforcement stays enabled whenever lending objects exist; disabling amendments or skipping visitors would remove these safeguards. 【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2422-L2489】 | New ledger objects or owner-directory shapes must extend invariant checks; omissions leave room for corrupted pseudo-accounts or stale directories to persist. 【F:include/xrpl/ledger/View.h†L640-L676】【F:src/xrpld/app/tx/detail/InvariantCheck.cpp†L2380-L2440】 |

